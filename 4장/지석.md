# 재조정

가상돔은 UI를 가진 청사진 -> 재조정 과정을 통해 실제 건물로 만든다. (웹 브라우저, 네이티브 등)

리액트가 컴포넌트를 만났을 때 내부적으로 어떻게 처리되는지

1. JSX -> 리액트 엘리먼트 트리

- createElement 또는 JSX의 <를 통해 생성됨
- 트리로 반환됨 -> 가상돔

# 일괄 처리

리액트는 재조정 과정에서 여러 돔 업데이트를 모아 한 번에 처리한다.
-> 돔 업데이트 횟수가 줄어 웹 애플리케이션 성능 향상

돔 트리를 두 개 가지고 변경점을 비교함 -> 현재 돔과 다음 돔의 상태를 일치하는 것

# 스택 재조정자

스택 재조정자는 앱의 규모가 커지면 여러 문제를 발생함

- 순차적으로 변경 사항을 렌더링
  - 일시 중지, 연기 x
- 계산 비용이 높은 컴포넌트가 상호작용이 필요한 컴포넌트의 렌더링을 막는다.

사용자 입력과 같은 상호작용은 우선순위가 높기에 현재 진행 중인 렌더링 작업을 멈출 수 있어야 함

스택 재조정자는 이런 우선순위 설정이 존재하지 않음
스택 재조정자는 추가된 순서대로 실행될 뿐

- 덜 중요한 업데이트가 우선순위 높은 렌더링을 막음

또한 업데이트를 중단하거나 취소할 수도 없음

> 토스트 알림창 같은 게 렌더링을 방해할 수도

# 파이버 재조정자

재조정을 위해 파이버라는 데이터 구조가 사용됨
파이버는 리액트 엘리먼트에서 생성됨
상태 저장과 수명이 길다. -> 수명이 길다는 게 무슨 의미?

> 특정 시점에 존재하는 실제 컴포넌트 트리르 나타내는 리액트 내부 데이터 구조

# 파이버 데이터 구조

컴포넌트 인스턴스와 그 상태를 표현함

- prop
- state
- children
- 위치 정보
- 업데이트 순위

## 컴포넌트 정보

- tag
  - 각 컴포넌트 유형을 나타나는 고유의 ID
- type
  - 파이버가 나타내는 함수 또는 클래스 컴포넌트
- props
  - 컴포넌트에 대한 props
- stateNode
  - 파이버 나타내는 앱 컴포넌트의 인스턴스

파이버 노드가 생성되면 작업 루프를 사용 -> beginWork -> completeWork 과정으로 진행

# 더블 버퍼링

업데이트 발생 시 현재 파이버 트리가 포크되어 새로운 상태를 반영하도록 업데이트 됨 -> 렌더링
그 후 현재 트리를 대체할 트리가 준비되면, 현재 파이버 트리와 교체됨 -> 커밋

- 현재 파이버를 포함하는 트리
- 작업용 파이버 트리

# 파이버 재조정

렌더링과 커밋으로 이루어짐
두 단계 덕분에 렌더링 중단이 가능해짐

- 스케줄러 도입으로 5ms 마다 메인 스레드로 실행을 양보함

## 렌더링

현재 트리에 상태 변경 이벤트가 발생하면 시작
파이버를 재귀적, 단계적 순회하고 업데이트가 보류 중이라는 플래그를 설정 -> 오프스크린 작업

beginWork로 발생함

### beginWork

작업 트리에 변경이 필요한 노드에 플래그를 설정함
트리 맨 아래 도달할 때까지 지속함
그 후 completeWork 호출 후 다시 올라감

- current
  - 작업용 노드에 해당하는 현재 파이버 노드에 대한 참조
  - 이전 트리와 비교용
- wip
  - 작업용 트리에서 업데이트 중인 파이버 노드
- renderLanes

  - 업데이트가 처리되는 레인
  - 우선순위가 높을수록 더 높은 레인
  - 업데이트 단위 쪼갬

### completeWork

업데이트 된 상태를 나타내는 돔 트리 생성
화면 밖에서 동작함
우선순위가 더 높은 업데이트가 예약되면 -> ui가 버려질 수 있음

트리 맨 위에 도달해 새 돔 트리를 구성하면 렌더링 단계 완료

## 커밋

실제 돔에 반영
호스트 환경에 커밋
작업용 트리 -> 현재 트리
현재 트리 -> 작업용 트리

### 변형 단계

가상 돔에 적용된 변경 사항을 실제 돔에 반영함

### 레이아웃 단계

새 레이아웃 계산 -> 실제 돔 반영

> 변형, 레이아웃 둘다 반영인데 뭐가 다른거임?
> 변형 단계 (Mutation Phase): "일단 짓고 부수자!" - 실제 DOM 노드를 추가, 수정, 삭제하는 구조적인 변경 작업만 실행합니다. 브라우저 렌더링을 차단하고 동기적으로 빠르게 처리합니다.
> 레이아웃 단계 (Layout Phase): "다 지었으니, 이제 확인하고 꾸미자!" - 변형 단계에서 변경된 DOM이 화면에 반영된 직후, 그 결과물(크기, 위치 등)을 확인하고 추가 작업을 하기 위해 실행됩니다.

### 효과

커밋 단계에서 아래와 같은 사이드 이펙트들이 실행된다

- 배치 효과
  - 돔에 새 컴포넌트 추가 시
- 업데이트 효과
  - prop, state 변경 시
- 삭제 효과
  - 컴포넌트가 돔에서 제거 시
- 레이아웃 효과
  - 페인트 시점 전에 발생해 레이아웃 업데이트 시

커밋 단계 효과와 달리 패시브 효과는 브라우저 페인트 후에 실행됨 유즈이펙트

> 근데 api 데이터 요청은 초기 렌더링에 중요한 거 아닌가?

### 화면에 표시

렌더링 프로세스가 완료되면 commitRoot 함수 호출에 실제 돔에 커밋한다.
commitRoot는 FiberRootNode의 포인터를 현재 트리에서 작업용 트리로 전환한 수 작업용 트리를 현재 트리로 만듦

이 작업을 계속 반복한다.
